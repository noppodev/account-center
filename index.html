<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noppo Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: var(--bg); }
        .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1.5rem; margin: 0.25rem 0.75rem; border-radius: 9999px; color: #5f6368; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .sidebar-link.active { background-color: #e8f0fe; color: var(--primary); }
        .sidebar-link:hover:not(.active) { background-color: #f1f3f4; }
        .glass-card { background: #ffffff; border: 1px solid #dadce0; border-radius: 1.5rem; overflow: hidden; }
        .btn-primary { background-color: var(--primary); color: white; padding: 0.6rem 1.5rem; border-radius: 9999px; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .loading-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; }
    </style>
</head>
<body class="min-h-screen">

    <!-- 読み込み中画面 -->
    <div id="loading-screen" class="loading-screen">
        <div class="text-3xl font-bold text-gray-800 mb-8 tracking-tighter">Noppo<span class="text-blue-600">ID</span></div>
        <div class="animate-pulse text-blue-600 font-bold">LOADING...</div>
    </div>

    <!-- ヘッダー -->
    <header class="h-16 border-b border-gray-200 bg-white/80 backdrop-blur-md sticky top-0 z-50 flex items-center justify-between px-6">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xs">N</div>
            <span class="text-xl font-semibold text-gray-700">Account</span>
        </div>
        <div id="auth-section">
            <button id="btn-login-top" onclick="goToLogin()" class="btn-primary">ログイン</button>
            <div id="user-info-top" class="hidden flex items-center gap-3">
                <div class="flex flex-col items-end mr-1 text-right text-xs">
                    <span id="nav-user-name" class="font-bold text-gray-800">...</span>
                    <span id="nav-user-email" class="text-gray-500">...</span>
                </div>
                <img id="nav-avatar" class="w-10 h-10 rounded-full border border-gray-200 cursor-pointer object-cover bg-gray-100" src="" alt="User Avatar" onclick="logout()">
            </div>
        </div>
    </header>

    <div class="flex max-w-7xl mx-auto">
        <!-- サイドナビ -->
        <nav class="w-64 hidden lg:block py-6 h-[calc(100vh-64px)] sticky top-16">
            <div class="sidebar-link active" onclick="switchTab('home')">
                <span class="material-symbols-outlined mr-4">home</span> ホーム
            </div>
            <div class="sidebar-link" onclick="switchTab('sync')">
                <span class="material-symbols-outlined mr-4">cloud_sync</span> デバイス同期
            </div>
            <div class="sidebar-link" onclick="switchTab('apps')">
                <span class="material-symbols-outlined mr-4">apps</span> 連携サービス
            </div>
        </nav>

        <!-- メインコンテンツ -->
        <main class="flex-1 p-6 md:p-10">
            <section id="tab-home">
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8 mb-12">
                        <img id="hero-avatar" class="w-32 h-32 rounded-full shadow-lg object-cover bg-gray-100 border-4 border-white" src="https://www.gstatic.com/images/branding/product/2x/avatar_anonymous_dark_round_64dp.png">
                        <div class="text-center md:text-left">
                            <h1 id="hero-welcome" class="text-4xl font-bold text-gray-900 mb-2">Noppo Account</h1>
                            <p id="hero-desc" class="text-gray-500">ログインするとすべての機能が利用可能になります。</p>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold mb-6 text-gray-800">利用可能なサービス</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-card p-5 flex items-center gap-4 hover:bg-gray-50 cursor-pointer transition-colors" onclick="window.open('https://browser.noppo.f5.si', '_blank')">
                            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined">browser_updated</span>
                            </div>
                            <div>
                                <h4 class="font-bold">NoppoBrowser</h4>
                                <p class="text-xs text-gray-500">クラウド同期対応ブラウザ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const AUTH_WORKER_URL = "https://noppo-auth.noppo5319.workers.dev";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2YXZhc3JkeGd1cWtpaWdjeGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTk5ODcsImV4cCI6MjA4Mjk5NTk4N30.CVq3lyRbxek7Ejs4tP5sN9-0JNEXSLtCsC2Pj-skFFQ";
        
        let user = null;

        async function init() {
            // チケットがある場合・ない場合含め、マニュアル通りの全自動取得
            user = await loadUser();
            
            if (user) {
                applyLoggedInState();
            }
            
            // ローディング画面を隠す
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
            }, 500);
        }

        /**
         * ユーザー情報を取得する（チケット自動交換対応）
         */
        async function loadUser() {
            const params = new URLSearchParams(window.location.search);
            const ticket = params.get('ticket');
            
            // チケットがあればチケット付きURL、なければ通常URL
            const url = ticket 
                ? `${AUTH_WORKER_URL}/auth/v1/user?ticket=${ticket}` 
                : `${AUTH_WORKER_URL}/auth/v1/user`;

            try {
                const res = await fetch(url, {
                    headers: { "apikey": SUPABASE_KEY }
                });

                if (res.ok) {
                    const userData = await res.json();
                    
                    // ログインに成功し、URLにチケットがあった場合は消して綺麗にする
                    if (ticket) {
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    }
                    return userData;
                }
            } catch (e) {
                console.error("ログイン情報の取得に失敗しました:", e);
            }
            return null;
        }

        /**
         * ログイン画面（Worker）へ飛ばす
         */
        function goToLogin() {
            const currentUrl = encodeURIComponent(window.location.href);
            window.location.href = `${AUTH_WORKER_URL}?redirect=${currentUrl}`;
        }

        /**
         * ログアウト処理
         */
        function logout() {
            // ログアウト後の戻り先を現在のトップページに指定
            const currentUrl = encodeURIComponent(window.location.origin + window.location.pathname);
            window.location.href = `${AUTH_WORKER_URL}/logout?redirect=${currentUrl}`;
        }

        /**
         * ログイン状態を画面に反映
         */
        function applyLoggedInState() {
            const meta = user.user_metadata || {};
            const name = meta.display_name || user.email || "ユーザー";
            const icon = meta.avatar_url || "https://www.gstatic.com/images/branding/product/2x/avatar_anonymous_dark_round_64dp.png";

            // ヘッダーの切り替え
            document.getElementById('btn-login-top').classList.add('hidden');
            document.getElementById('user-info-top').classList.remove('hidden');
            document.getElementById('nav-user-name').innerText = name;
            document.getElementById('nav-user-email').innerText = user.email;
            document.getElementById('nav-avatar').src = icon;

            // メインエリアの切り替え
            document.getElementById('hero-avatar').src = icon;
            document.getElementById('hero-welcome').innerText = `${name} さん、こんにちは`;
            document.getElementById('hero-desc').innerText = "Noppo ID でのクラウド同期が有効です。";
        }

        /**
         * タブ切り替え（今回はホームのみ実装）
         */
        function switchTab(id) {
            if (id !== 'home') {
                alert("この機能は現在準備中です。");
                return;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
